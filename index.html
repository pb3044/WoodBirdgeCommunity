<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Woodbridge Community Events</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #2c5f7d;
            --secondary: #4a9eba;
            --accent: #f39c12;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-bottom: 2rem;
        }
        
        .app-container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        .app-header {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .app-header h1 {
            color: var(--primary);
            margin-bottom: 0.5rem;
            font-weight: 700;
        }
        
        .app-header p {
            color: #6c757d;
            margin: 0;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        
        .event-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .event-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        .event-date {
            background: var(--accent);
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: 700;
            min-width: 80px;
        }
        
        .event-date .day {
            font-size: 2rem;
            line-height: 1;
        }
        
        .event-date .month {
            font-size: 0.9rem;
            text-transform: uppercase;
        }
        
        .btn-primary {
            background: var(--secondary);
            border: none;
            border-radius: 10px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-danger {
            border-radius: 8px;
        }
        
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 0.75rem;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 0 0.2rem rgba(74, 158, 186, 0.25);
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        
        .badge {
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-weight: 600;
        }
        
        @media (max-width: 576px) {
            .event-date {
                min-width: 70px;
                padding: 0.75rem;
            }
            
            .event-date .day {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <h1><i class="fas fa-calendar-alt"></i> Woodbridge Community</h1>
            <p>Stay connected with local events</p>
        </div>
        
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-3" id="formTitle"><i class="fas fa-plus-circle"></i> Add New Event</h5>
                <form id="eventForm">
                    <input type="hidden" id="eventId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Event Name *</label>
                            <input type="text" class="form-control" id="eventName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Date *</label>
                            <input type="date" class="form-control" id="eventDate" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Time *</label>
                            <input type="time" class="form-control" id="eventTime" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Location *</label>
                            <input type="text" class="form-control" id="eventLocation" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="eventDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <select class="form-select" id="eventCategory">
                            <option value="Social">Social</option>
                            <option value="Sports">Sports</option>
                            <option value="Meeting">Meeting</option>
                            <option value="Workshop">Workshop</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary flex-grow-1" id="submitBtn">
                            <i class="fas fa-save"></i> <span id="submitText">Add Event</span>
                        </button>
                        <button type="button" class="btn btn-secondary" id="cancelBtn" style="display: none;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-4"><i class="fas fa-calendar-check"></i> Upcoming Events</h5>
                <div id="eventsList"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            let events = [];
            let editingId = null;
            
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            $('#eventDate').attr('min', today);
            
            // Load events from persistent storage on page load
            loadEvents();
            
            // Form submission
            $('#eventForm').on('submit', async function(e) {
                e.preventDefault();
                
                if (editingId) {
                    // Update existing event
                    const index = events.findIndex(e => e.id === editingId);
                    if (index !== -1) {
                        events[index] = {
                            id: editingId,
                            name: $('#eventName').val(),
                            date: $('#eventDate').val(),
                            time: $('#eventTime').val(),
                            location: $('#eventLocation').val(),
                            description: $('#eventDescription').val(),
                            category: $('#eventCategory').val()
                        };
                        showToast('Event updated successfully!');
                    }
                    editingId = null;
                    resetForm();
                } else {
                    // Add new event
                    const event = {
                        id: Date.now(),
                        name: $('#eventName').val(),
                        date: $('#eventDate').val(),
                        time: $('#eventTime').val(),
                        location: $('#eventLocation').val(),
                        description: $('#eventDescription').val(),
                        category: $('#eventCategory').val()
                    };
                    events.push(event);
                    showToast('Event added successfully!');
                }
                
                await saveEvents();
                displayEvents();
                
                // Reset form
                this.reset();
            });
            
            // Cancel edit button
            $('#cancelBtn').on('click', function() {
                editingId = null;
                resetForm();
                $('#eventForm')[0].reset();
            });
            
            function resetForm() {
                editingId = null;
                $('#eventId').val('');
                $('#formTitle').html('<i class="fas fa-plus-circle"></i> Add New Event');
                $('#submitText').text('Add Event');
                $('#cancelBtn').hide();
                $('#submitBtn').removeClass('btn-warning').addClass('btn-primary');
            }
            
            async function saveEvents() {
                try {
                    // Save all events to persistent storage
                    const result = await window.storage.set('woodbridge-events', JSON.stringify(events), true);
                    if (!result) {
                        console.error('Failed to save events');
                        showToast('Error saving event. Please try again.', 'danger');
                    }
                } catch (error) {
                    console.error('Storage error:', error);
                    showToast('Error saving event. Please try again.', 'danger');
                }
            }
            
            async function loadEvents() {
                try {
                    // Load events from persistent storage
                    const result = await window.storage.get('woodbridge-events', true);
                    if (result && result.value) {
                        events = JSON.parse(result.value);
                    }
                } catch (error) {
                    console.log('No existing events found, starting fresh');
                    events = [];
                }
                displayEvents();
            }
            
            function displayEvents() {
                const $list = $('#eventsList');
                
                if (events.length === 0) {
                    $list.html(`
                        <div class="empty-state">
                            <i class="fas fa-calendar-times"></i>
                            <h5>No events yet</h5>
                            <p>Add your first community event above!</p>
                        </div>
                    `);
                    return;
                }
                
                // Sort events by date
                const sortedEvents = [...events].sort((a, b) => {
                    return new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time);
                });
                
                let html = '';
                sortedEvents.forEach(event => {
                    const eventDate = new Date(event.date);
                    const day = eventDate.getDate();
                    const month = eventDate.toLocaleString('default', { month: 'short' });
                    
                    const categoryColors = {
                        'Social': 'bg-primary',
                        'Sports': 'bg-success',
                        'Meeting': 'bg-info',
                        'Workshop': 'bg-warning',
                        'Other': 'bg-secondary'
                    };
                    
                    html += `
                        <div class="card event-card mb-3">
                            <div class="card-body p-0">
                                <div class="d-flex">
                                    <div class="event-date">
                                        <div class="day">${day}</div>
                                        <div class="month">${month}</div>
                                    </div>
                                    <div class="flex-grow-1 p-3">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h5 class="mb-1">${event.name}</h5>
                                            <span class="badge ${categoryColors[event.category]}">${event.category}</span>
                                        </div>
                                        <p class="mb-2 text-muted">
                                            <i class="fas fa-clock"></i> ${event.time} | 
                                            <i class="fas fa-map-marker-alt"></i> ${event.location}
                                        </p>
                                        ${event.description ? `<p class="mb-2">${event.description}</p>` : ''}
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-warning btn-sm" onclick="editEvent(${event.id})">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                            <button class="btn btn-danger btn-sm" onclick="deleteEvent(${event.id})">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                $list.html(html);
            }
            
            window.editEvent = function(id) {
                const event = events.find(e => e.id === id);
                if (!event) return;
                
                editingId = id;
                $('#eventId').val(event.id);
                $('#eventName').val(event.name);
                $('#eventDate').val(event.date);
                $('#eventTime').val(event.time);
                $('#eventLocation').val(event.location);
                $('#eventDescription').val(event.description);
                $('#eventCategory').val(event.category);
                
                $('#formTitle').html('<i class="fas fa-edit"></i> Edit Event');
                $('#submitText').text('Update Event');
                $('#submitBtn').removeClass('btn-primary').addClass('btn-warning');
                $('#cancelBtn').show();
                
                // Scroll to form
                $('html, body').animate({
                    scrollTop: $('#eventForm').offset().top - 100
                }, 500);
            };
            
            window.deleteEvent = async function(id) {
                if (confirm('Are you sure you want to delete this event?')) {
                    events = events.filter(e => e.id !== id);
                    await saveEvents();
                    displayEvents();
                    showToast('Event deleted successfully!');
                }
            };
            
            function showToast(message, type = 'success') {
                const iconClass = type === 'success' ? 'fa-check-circle text-success' : 'fa-exclamation-circle text-danger';
                const toast = $(`
                    <div class="position-fixed top-0 end-0 p-3" style="z-index: 9999">
                        <div class="toast show" role="alert">
                            <div class="toast-header">
                                <i class="fas ${iconClass} me-2"></i>
                                <strong class="me-auto">${type === 'success' ? 'Success' : 'Error'}</strong>
                                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                            </div>
                            <div class="toast-body">${message}</div>
                        </div>
                    </div>
                `);
                
                $('body').append(toast);
                setTimeout(() => toast.remove(), 3000);
            }
        });
    </script>
</body>
</html>
